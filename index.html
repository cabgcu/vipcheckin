<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>CAB VIP Check In System</title>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root {
  --bg-dark: #000000;
  --glass-surface: rgba(15, 15, 15, 0.85); 
  --glass-border: rgba(255, 255, 255, 0.1);
  --text-main: #ffffff;
  --text-muted: #a1a1aa;
  --gradient-accent: linear-gradient(135deg, #0A84FF, #BF5AF2);
  --gradient-success: linear-gradient(135deg, #34C759, #30B0C7);
  --radius-card: 28px;
  --radius-pill: 100px;
  --blur: 40px;
  --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; font-family: var(--font-stack); color: var(--text-main); background-color: var(--bg-dark);
  min-height: 100vh; padding-bottom: 40px; -webkit-font-smoothing: antialiased; overflow-x: hidden;
}

.frosted {
  background: var(--glass-surface); backdrop-filter: blur(var(--blur)) saturate(150%);
  -webkit-backdrop-filter: blur(var(--blur)) saturate(150%); border: 1px solid var(--glass-border);
}

.app-container { max-width: 1440px; margin: 0 auto; padding: 0 40px; display: flex; flex-direction: column; }

.topbar {
  position: sticky; top: 20px; z-index: 50; display: flex; justify-content: space-between; align-items: center;
  padding: 20px 32px; border-radius: var(--radius-card); margin-bottom: 40px; margin-top: 20px;
}

.brand-text h1 {
  font-size: 1.4rem; font-weight: 800; margin: 0;
  background: var(--gradient-accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

.controls { display: flex; gap: 10px; flex-wrap: wrap; }
.control-item {
  background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08);
  color: #fff; padding: 0 16px; border-radius: var(--radius-pill); font-weight: 600;
  height: 42px; display: flex; align-items: center; cursor: pointer; transition: 0.2s; font-size: 0.85rem;
}
.control-item.active { background: var(--gradient-accent); border: none; }

.stats-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
.stat-card { padding: 24px; border-radius: var(--radius-card); text-align: center; }
.stat-val { font-size: 2.5rem; font-weight: 800; display: block; }
.stat-label { font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.1em; }

/* Scanner Container */
#reader { width: 100%; max-width: 600px; margin: 0 auto; border-radius: 20px; overflow: hidden; border: 1px solid var(--glass-border) !important; }

/* Table */
.table-container { margin-top: 20px; border-radius: var(--radius-card); overflow-x: auto; }
table { width: 100%; border-collapse: separate; border-spacing: 0 8px; min-width: 800px; }
th { padding: 16px; text-align: left; color: var(--text-muted); font-size: 0.75rem; letter-spacing: 0.1em; }
td { padding: 20px 16px; background: rgba(255,255,255,0.03); border-top: 1px solid var(--glass-border); border-bottom: 1px solid var(--glass-border); }
td:first-child { border-left: 1px solid var(--glass-border); border-top-left-radius: 16px; border-bottom-left-radius: 16px; }
td:last-child { border-right: 1px solid var(--glass-border); border-top-right-radius: 16px; border-bottom-right-radius: 16px; }

.group-tag { font-size: 0.7rem; font-weight: 700; color: #BF5AF2; margin-top: 4px; display: block; text-transform: uppercase; }
.btn-action { background: var(--gradient-accent); border: none; padding: 8px 16px; border-radius: 10px; color: #fff; font-weight: 700; cursor: pointer; }
.modern-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 14px; border-radius: 12px; color: white; outline: none; }
.form-card { padding: 40px; border-radius: var(--radius-card); max-width: 800px; margin: 0 auto; }

@media(max-width: 900px) {
  .topbar { flex-direction: column; gap: 20px; text-align: center; padding: 20px; height: auto; }
  .stats-container { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="app-container">
  <div class="frosted topbar">
    <div class="brand">
      <div class="brand-text">
        <h1>CAB VIP System</h1>
        <div style="font-size:0.85rem; color:var(--text-muted); margin-top:4px;">
          Event: <select id="eventDropdown" class="modern-input" style="width:auto; height:auto; padding:4px 8px; display:inline-block;" onchange="switchEvent(this.value)">
            <option value="">Loading...</option>
          </select>
        </div>
      </div>
    </div>
    <div class="controls">
      <button onclick="toggleView('list')" id="nav-list" class="control-item active">üìã VIP LIST</button>
      <button onclick="toggleView('scan')" id="nav-scan" class="control-item">üì∏ SCANNER</button>
      <button onclick="toggleView('add')" id="nav-add" class="control-item">üë§ ADD</button>
      <button onclick="toggleView('settings')" id="nav-settings" class="control-item">‚öôÔ∏è SETTINGS</button>
    </div>
  </div>

  <div class="stats-container" id="statsBar">
    <div class="frosted stat-card">
      <span class="stat-label">Total VIPs</span>
      <span class="stat-val" id="countTotal">0</span>
    </div>
    <div class="frosted stat-card">
      <span class="stat-label">Checked In</span>
      <span class="stat-val" style="color:#34C759" id="countIn">0</span>
    </div>
    <div class="frosted stat-card">
      <span class="stat-label">Remaining</span>
      <span class="stat-val" style="color:#0A84FF" id="countLeft">0</span>
    </div>
  </div>

  <div id="view-list" class="view">
    <div style="display:flex; gap:12px; margin-bottom: 30px;">
      <input type="text" id="search" class="modern-input" placeholder="Search guests..." onkeyup="filterTable()" style="flex:1;">
      <button onclick="sendBulk()" id="blastBtn" class="btn-action" style="padding:0 30px; white-space:nowrap;">üöÄ BLAST TICKETS</button>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>FIRST</th><th>LAST</th><th>PHONE</th><th>EMAIL</th><th>SHIRT SIZE</th><th>CHECK IN</th><th>RESEND</th>
          </tr>
        </thead>
        <tbody id="guestTableBody"></tbody>
      </table>
    </div>
  </div>

  <div id="view-scan" class="view" style="display:none;">
    <div class="frosted form-card">
      <h2 style="text-align:center; margin-bottom:20px;">QR Scanner</h2>
      <div id="reader"></div>
      <p style="text-align:center; color:var(--text-muted); margin-top:20px;">Point camera at a ticket QR code to check in.</p>
    </div>
  </div>

  <div id="view-add" class="view" style="display:none;">
    <div class="frosted form-card">
      <h2 class="mb-4">Add VIP to <span id="addEventLabel" style="color:#BF5AF2">...</span></h2>
      <form id="vipForm">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
          <input type="text" id="first" class="modern-input" placeholder="First Name" required>
          <input type="text" id="last" class="modern-input" placeholder="Last Name" required>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
          <input type="tel" id="phone" class="modern-input" placeholder="Phone" required>
          <input type="email" id="email" class="modern-input" placeholder="Email" required>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
          <select id="groupSelect" class="modern-input" required><option value="">Assign Group...</option></select>
          <select id="shirtSize" class="modern-input" required>
            <option value="" disabled selected>Shirt Size</option>
            <option>S</option><option>M</option><option>L</option><option>XL</option><option>2XL</option>
          </select>
        </div>
        <button type="submit" class="btn-action" style="width:100%; padding:18px; margin-top:30px;">Add VIP Guest</button>
      </form>
    </div>
  </div>

  <div id="view-settings" class="view" style="display:none;">
    <div class="frosted form-card">
      <h2>System Settings</h2>
      <div style="margin-bottom:30px;">
        <label style="color:var(--text-muted); font-size:0.8rem; font-weight:bold;">START NEW EVENT</label>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <input type="text" id="newEventName" class="modern-input" placeholder="e.g. Midnight Madness">
          <button onclick="createNewEvent()" class="btn-action">Create</button>
        </div>
      </div>
      <div>
        <label style="color:var(--text-muted); font-size:0.8rem; font-weight:bold;">ADD GROUP TO ACTIVE EVENT</label>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <input type="text" id="newGroupName" class="modern-input" placeholder="e.g. Dance Team">
          <button onclick="createNewGroup()" class="btn-action">Add</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// UPDATED URL
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwc7Xw760Lgi-mLn2jEH5yLweCqpQIIy6okEpf32oAodG78FAmuqdHREGIk0olixVHkJw/exec";
let html5QrcodeScanner = null;

async function api(action, params = {}) {
    const url = new URL(WEB_APP_URL);
    url.searchParams.append('action', action);
    for (const key in params) url.searchParams.append(key, params[key]);
    try {
        const response = await fetch(url);
        return await response.json();
    } catch (e) {
        console.error("API Error:", e);
        return { vips: [], groups: [], allEvents: [] };
    }
}

async function refreshData(eventId = null) {
    const data = await api('getAppData', eventId ? { eventId } : {});
    renderUI(data);
}

function renderUI(data) {
    if(!data || !data.vips) return;
    document.getElementById('countTotal').innerText = data.vips.length;
    document.getElementById('countIn').innerText = data.vips.filter(v => v.status === 'Checked In').length;
    document.getElementById('countLeft').innerText = data.vips.length - data.vips.filter(v => v.status === 'Checked In').length;
    
    document.getElementById('eventDropdown').innerHTML = data.allEvents.map(e => 
        `<option value="${e.id}" ${e.id == data.activeEventId ? 'selected' : ''}>${e.name}</option>`
    ).join('');
    
    document.getElementById('addEventLabel').innerText = data.activeEventName;
    document.getElementById('groupSelect').innerHTML = '<option value="" disabled selected>Assign Group...</option>' + 
        data.groups.map(g => `<option value="${g.name}">${g.name}</option>`).join('');
    
    const tbody = document.getElementById('guestTableBody');
    tbody.innerHTML = data.vips.map(v => `
        <tr>
            <td>${v.first}<span class="group-tag">${v.team}</span></td>
            <td class="fw-bold">${v.last}</td>
            <td><small>${v.phone}</small></td>
            <td><small>${v.email}</small></td>
            <td><span style="color:#BF5AF2; font-weight:800;">${v.shirtSize}</span></td>
            <td><button onclick="checkIn('${v.id}')" class="btn-action" style="${v.status === 'Checked In' ? 'background:var(--gradient-success)' : ''}">${v.status === 'Checked In' ? 'ARRIVED' : 'MARK'}</button></td>
            <td><button onclick="resend('${v.id}')" style="background:transparent; border:none; cursor:pointer;">üîÑ</button></td>
        </tr>
    `).join('');
}

function toggleView(view) {
    document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
    document.querySelectorAll('.control-item').forEach(btn => btn.classList.remove('active'));
    document.getElementById('view-' + view).style.display = 'block';
    document.getElementById('nav-' + view).classList.add('active');
    
    if (view === 'scan') {
        if (!html5QrcodeScanner) {
            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            html5QrcodeScanner.render(onScanSuccess);
        }
    } else if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
        html5QrcodeScanner = null;
    }
}

function onScanSuccess(decodedText) {
    const urlParams = new URLSearchParams(decodedText.split('?')[1]);
    const id = urlParams.get('id');
    if (id) { checkIn(id); alert("Success: Guest Checked In!"); }
}

async function switchEvent(id) { await refreshData(id); }
async function checkIn(id) { await api('autoCheckIn', { id }); refreshData(); }
async function resend(id) { if(confirm("Resend ticket?")) { await api('resendSingleTicket', { guestId: id }); alert("Ticket resent!"); } }

async function createNewEvent() {
    const name = document.getElementById('newEventName').value;
    if(name) { 
        await api('addEvent', { name }); 
        document.getElementById('newEventName').value = ''; 
        refreshData(); 
        alert("Event Created!");
    }
}

async function createNewGroup() {
    const name = document.getElementById('newGroupName').value;
    if(name) { 
        await api('addGroup', { name }); 
        document.getElementById('newGroupName').value = ''; 
        refreshData(); 
        alert("Group Added!");
    }
}

document.getElementById('vipForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const params = {
        first: document.getElementById('first').value,
        last: document.getElementById('last').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        team: document.getElementById('groupSelect').value,
        shirtSize: document.getElementById('shirtSize').value
    };
    await api('addVip', params);
    e.target.reset();
    toggleView('list');
    refreshData();
});

function filterTable() {
    const val = document.getElementById("search").value.toUpperCase();
    document.querySelectorAll("#guestTableBody tr").forEach(r => r.style.display = r.innerText.toUpperCase().includes(val) ? "" : "none");
}

window.onload = () => refreshData();
</script>
</body>
</html>
